<!DOCTYPE html>
<html>
<head>
    <title>Intelligent Data Dictionary Agent</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: Arial; margin:0; background:#f4f6f9;}
        header { background:#2c3e50; color:white; padding:18px; text-align:center; font-size:20px;}
        .container { display:flex; min-height:90vh;}
        .sidebar { width:25%; background:white; padding:20px; border-right:1px solid #ddd;}
        .main { width:75%; padding:20px;}
        .box { background:white; padding:15px; margin-bottom:20px; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.08);}
        button { padding:6px 10px; background:#3498db; color:white; border:none; border-radius:4px; cursor:pointer;}
        button:hover { background:#2980b9;}
        input { padding:6px; width:70%; margin-bottom:8px;}
        .note { font-size:13px; color:#555;}
        .success { color:#27ae60; }
        pre { background:#f4f4f4; padding:10px; border-radius:5px;}
    </style>
</head>
<body>

<header> Intelligent Data Dictionary Agent </header>

<div class="container">
    <div class="sidebar">
        <h3>ðŸ“‚ Upload Excel</h3>
        <input type="file" id="fileInput"><br>
        <button onclick="uploadFile()">Upload</button>
        <div id="uploadStatus" class="note"></div>
        <hr>
        <h3>ðŸ—„ Connect SQLite Database</h3>
        <input type="text" id="dbName" placeholder="Enter database name"><br>
        <button onclick="connectDB()">Connect</button>
        <div id="dbStatus" class="note"></div>
        <hr>
        <h3>ðŸ“Š Select Table</h3>
        <div id="tableList" class="note">Upload a file or connect DB first.</div>
    </div>

    <div class="main">
        <div class="box">
            <h3>Table Details</h3>
            <div id="tableDetails" class="note">Please select a table.</div>
        </div>

        <div class="box">
            <h3>Ask Question</h3>
            <input type="text" id="questionInput" placeholder="Ask about average, rows, max, min, total...">
            <button onclick="askQuestion()">Ask</button>
            <div id="answerBox" style="margin-top:15px;"></div>
            <div id="chartContainer" style="margin-top:20px; height:400px;"></div>
        </div>
    </div>
</div>

<script>
let selectedTable = ""

function uploadFile(){
    const file = document.getElementById("fileInput").files[0]
    if(!file){ alert("Choose a file first."); return; }

    const formData = new FormData()
    formData.append("file", file)

    fetch("/upload", { method:"POST", body: formData })
    .then(res=>res.json())
    .then(data=>{
        document.getElementById("uploadStatus").innerHTML = "<span class='success'>File uploaded successfully.</span>"
        let html=""
        data.tables.forEach(t=>{
            html += `<div><button onclick="selectTable('${t}')">${t}</button></div>`
        })
        document.getElementById("tableList").innerHTML = html
    })
}

function connectDB(){
    const dbName = document.getElementById("dbName").value

    fetch("/connect_sql", {
        method:"POST",
        headers:{ "Content-Type":"application/json"},
        body: JSON.stringify({ database: dbName })
    })
    .then(res=>res.json())
    .then(data=>{
        document.getElementById("dbStatus").innerHTML =
            "<span class='success'>"+data.message+"</span>"

        // SHOW TABLES
        let html=""
        if(data.tables.length === 0){
            html = "No tables found in database."
        } else {
            data.tables.forEach(t=>{
                html += `<div><button onclick="selectTable('${t}')">${t}</button></div>`
            })
        }
        document.getElementById("tableList").innerHTML = html
    })
}

function selectTable(table){
    selectedTable = table
    fetch("/table/"+table)
    .then(res=>res.json())
    .then(data=>{
        document.getElementById("tableDetails").innerHTML =
            "<b>Columns:</b> "+data.columns.join(", ") +
            "<br><b>Rows:</b> "+data.row_count
    })
}

function askQuestion(){
    if(selectedTable===""){ alert("Select a table first."); return; }
    const question = document.getElementById("questionInput").value
    const chartBox = document.getElementById("chartContainer");
    const answerBox = document.getElementById("answerBox");

    fetch("/ask", {
        method:"POST",
        headers:{ "Content-Type":"application/json"},
        body: JSON.stringify({ question: question, table: selectedTable })
    })
    .then(res=>res.json())
    .then(data=>{
        // Clear previous chart
        chartBox.innerHTML = "";
        
        // Handle Text Answer
        if(typeof data.answer === "object"){
            answerBox.innerHTML = "<pre>"+JSON.stringify(data.answer,null,2)+"</pre>"
        } else {
            answerBox.innerText = data.answer
        }

        // Handle Chart Rendering
        if(data.chart) {
            const plotData = JSON.parse(data.chart);
            Plotly.newPlot('chartContainer', plotData.data, plotData.layout);
        }
    })
}
</script>
</body>
</html>
